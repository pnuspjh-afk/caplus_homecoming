<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì„œìš¸ ì£¼ìš” ê¸°ì—… ë³¸ì‚¬/ì‚¬ì˜¥ ìœ„ì¹˜ ì§€ë„ & ì„ ë°° ëª…ë‹¨</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <!-- Leaflet Geocoder CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
    
    <style>
        body { margin: 0; padding: 0; font-family: 'Noto Sans KR', sans-serif; display: flex; height: 100vh; overflow: hidden; }
        
        /* ì™¼ìª½ ì§€ë„ ì˜ì—­ */
        #map-container {
            flex: 3; /* 75% width */
            position: relative;
            transition: flex 0.3s ease;
        }
        #map { height: 100%; width: 100%; }
        
        /* ì˜¤ë¥¸ìª½ ì‚¬ì´ë“œë°” ì˜ì—­ */
        #sidebar {
            flex: 1; /* 25% width */
            min-width: 320px;
            background: #f8f9fa;
            border-left: 1px solid #ddd;
            display: flex;
            flex-direction: column;
            box-shadow: -2px 0 5px rgba(0,0,0,0.05);
            z-index: 1000;
            transition: min-width 0.3s ease, flex 0.3s ease, opacity 0.3s ease;
        }

        /* ë¦¬ìŠ¤íŠ¸ ìŠ¤íƒ€ì¼ */
        #list-content {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
        }
        .person-card {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            border: 1px solid #eee;
            transition: transform 0.2s, box-shadow 0.2s;
            cursor: pointer;
        }
        .person-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            border-color: #0066FF;
        }
        .person-card.pending-card { /* ë³´ë¥˜ ëª…ë‹¨ ìŠ¤íƒ€ì¼ êµ¬ë¶„ */
            border-left: 4px solid #aaa;
            background: #fafafa;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        .name { font-size: 18px; font-weight: bold; color: #333; }
        .cp-badge {
            background: #333;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
        }
        .info-row {
            font-size: 14px;
            color: #555;
            margin-bottom: 4px;
            display: flex;
            align-items: center;
        }
        .info-icon { margin-right: 6px; width: 14px; text-align: center; }
        
        .phone-text { color: #555; font-weight: 500; letter-spacing: 0.5px; }
        
        .company-tag {
            display: inline-block;
            margin-top: 6px;
            padding: 3px 8px;
            background: #eef4ff;
            color: #0066FF;
            border-radius: 4px;
            font-size: 13px;
            font-weight: 600;
        }
        .loc-tag {
            color: #888;
            font-size: 13px;
            margin-left: auto;
        }

        /* ë²”ë¡€ */
        .legend {
            background: white;
            padding: 10px 15px;
            border-radius: 8px;
            box-shadow: 0 0 15px rgba(0,0,0,0.2);
            line-height: 1.5;
            font-size: 14px;
            color: #333;
        }
        .legend i { width: 12px; height: 12px; display: inline-block; margin-right: 8px; border-radius: 50%; }
        .legend-title { font-weight: bold; margin-bottom: 5px; display: block; font-size: 15px; }

        /* ë§ˆì»¤/íŒì—… */
        .custom-marker {
            display: flex;
            justify-content: center;
            align-items: center;
            border-radius: 50%;
            color: white;
            font-weight: bold;
            font-size: 10px;
            border: 2px solid white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }
        .leaflet-popup-content-wrapper { border-radius: 8px; box-shadow: 0 3px 14px rgba(0,0,0,0.4); min-width: 200px; }
        .popup-title { font-weight: bold; font-size: 1.1em; margin-bottom: 5px; display: block; color: #333; }
        .popup-desc { font-size: 0.9em; color: #666; margin-bottom: 8px; display: block; }
        .popup-badge { display: inline-block; padding: 2px 6px; border-radius: 4px; color: white; font-size: 0.8em; margin-bottom: 6px; }
        .popup-members { background-color: #f8f9fa; border-top: 1px solid #eee; padding-top: 8px; margin-top: 5px; font-size: 0.9em; color: #444; }
        .member-row { display: block; margin-bottom: 2px; font-weight: 500; }

        @media (max-width: 768px) {
            body { flex-direction: column; }
            #map-container { flex: 1; height: 50vh; }
            #sidebar { flex: 1; height: 50vh; min-width: 100%; border-left: none; border-top: 1px solid #ddd; }
        }

        /* ëª¨ë‹¬ & ë²„íŠ¼ */
        #modal-overlay {
            display: none;
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); z-index: 2000;
            justify-content: center; align-items: center;
        }
        #add-modal {
            background: white; padding: 25px; border-radius: 10px;
            width: 320px; max-width: 90%;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            position: relative;
        }
        #add-modal h3 { margin-top: 0; margin-bottom: 15px; color: #333; }
        .form-group { margin-bottom: 12px; }
        .form-group label { display: block; font-size: 13px; font-weight: bold; margin-bottom: 5px; color: #555; }
        .form-group input, .form-group select {
            width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; font-size: 14px;
        }
        .coord-group { display: flex; gap: 5px; }
        .coord-btn {
            background: #666; color: white; border: none; padding: 0 10px; border-radius: 4px; cursor: pointer; font-size: 12px; white-space: nowrap;
        }
        .coord-btn.picking { background: #E63946; animation: pulse 1s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.7; } 100% { opacity: 1; } }
        
        .modal-footer { margin-top: 20px; display: flex; justify-content: flex-end; gap: 10px; }
        .btn-cancel { background: #eee; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; }
        .btn-save { background: #0066FF; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; font-weight: bold; }

        .add-fab {
            background: #0066FF; color: white; text-align: center;
            font-weight: bold; cursor: pointer; border: none; border-radius: 4px;
            font-size: 15px; transition: background 0.2s;
            padding: 10px;
        }
        .add-fab:hover { background: #0052cc; }

        /* ì§€ë„ ìœ„ í”Œë¡œíŒ… ë²„íŠ¼ ìŠ¤íƒ€ì¼ (êµ¬ê¸€ë§µ ìŠ¤íƒ€ì¼ ì ìš©) */
        .map-float-btn {
            position: absolute; left: 10px; z-index: 1000;
            background: white; 
            border: none; /* í…Œë‘ë¦¬ ì œê±° */
            border-radius: 24px; /* ë‘¥ê·¼ ì¹© ìŠ¤íƒ€ì¼ (ì•Œì•½ ëª¨ì–‘) */
            padding: 10px 16px 10px 12px; /* ì•„ì´ì½˜ ê³ ë ¤í•œ íŒ¨ë”© */
            cursor: pointer; 
            font-weight: 500;
            font-size: 14px;
            color: #3c4043; /* êµ¬ê¸€ë§µ í…ìŠ¤íŠ¸ ì»¬ëŸ¬ */
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
            display: flex;
            align-items: center;
            gap: 8px; /* ì•„ì´ì½˜ê³¼ í…ìŠ¤íŠ¸ ê°„ê²© */
            transition: background-color 0.2s, box-shadow 0.2s;
        }
        .map-float-btn:hover { 
            background: #f1f3f4; 
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }
        .map-float-btn.active { 
            background: #e8f0fe; 
            color: #1967d2; 
        }
        /* SVG ì•„ì´ì½˜ ìŠ¤íƒ€ì¼ */
        .map-float-btn svg {
            fill: currentColor;
            width: 18px;
            height: 18px;
        }

        #btn-show-list { top: 70px; display: none; }
        #btn-toggle-pending { top: 120px; }

        /* ì‚¬ì´ë“œë°” í—¤ë” */
        .sidebar-header {
            padding: 15px; border-bottom: 1px solid #ddd;
            display: flex; justify-content: space-between; align-items: center;
            background: white;
        }
        .header-title { font-size: 18px; font-weight: bold; color: #333; }
        .toggle-label { font-size: 14px; cursor: pointer; user-select: none; color: #555; display: flex; align-items: center; }
        .toggle-label input { margin-right: 6px; }

        /* ë¡œê·¸ì¸ ì˜¤ë²„ë ˆì´ ìŠ¤íƒ€ì¼ ì œê±°ë¨ */
    </style>
</head>
<body>

<!-- ë¡œê·¸ì¸ ì˜¤ë²„ë ˆì´ ì œê±°ë¨ -->

<div id="map-container">
    <div id="map"></div>
    <!-- ëª…ë‹¨ ë³´ê¸° ë²„íŠ¼ (ì‚¬ì´ë“œë°” ë‹«í˜”ì„ ë•Œ) -->
    <button id="btn-show-list" class="map-float-btn" onclick="toggleSidebar(true)">
        <svg viewBox="0 0 24 24"><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg>
        ëª…ë‹¨ ë³´ê¸°
    </button>
    <!-- ë³´ë¥˜ í¬í•¨ í† ê¸€ ë²„íŠ¼ (ì§€ë„ ìœ„) -->
    <button id="btn-toggle-pending" class="map-float-btn" onclick="togglePending(!isPendingShown)">
        <svg viewBox="0 0 24 24"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg>
        ë³´ë¥˜ í¬í•¨
    </button>
</div>

<div id="sidebar">
    <!-- ë“±ë¡/ë‹«ê¸° ë²„íŠ¼ ì˜ì—­ -->
    <div style="display: flex; gap: 8px; padding: 10px 15px 5px;">
        <button class="add-fab" onclick="openModal()" style="flex: 1;">+ ì¥ì†Œ / ì„ ë°° ë“±ë¡</button>
        <button onclick="toggleSidebar(false)" style="width: 40px; background: #eee; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; color:#555;">âœ–ï¸</button>
    </div>

    <!-- ë¦¬ìŠ¤íŠ¸ í—¤ë” ë° ì»¨íŠ¸ë¡¤ -->
    <div class="sidebar-header">
        <span class="header-title">ì°¸ì„ì ëª…ë‹¨</span>
        <label class="toggle-label">
            <input type="checkbox" id="chk-pending" onchange="togglePending(this.checked)"> ë³´ë¥˜ í¬í•¨
        </label>
    </div>

    <div id="list-content"></div>
</div>

<div id="modal-overlay">
    <div id="add-modal">
        <h3>ğŸ“ ìƒˆ ì¥ì†Œ/ì„ ë°° ë“±ë¡</h3>
        <div class="form-group">
            <label>íšŒì‚¬/ì¥ì†Œëª… *</label>
            <input type="text" id="input-company" placeholder="ì˜ˆ: ì‚¼ì„±ì „ì">
        </div>
        <div class="form-group">
            <label>ì—…ë¬´ì§€êµ¬ (ê·¸ë£¹) *</label>
            <select id="input-group">
                <option value="CBD">CBD (ë„ì‹¬)</option>
                <option value="GBD">GBD (ê°•ë‚¨)</option>
                <option value="YBD">YBD (ì—¬ì˜ë„)</option>
                <option value="ê¸°íƒ€(ì„œìš¸)">ê¸°íƒ€ (ì„œìš¸)</option>
                <option value="ê²½ê¸°ê¶Œ">ê²½ê¸°ê¶Œ</option>
                <option value="ì„œìš¸ì—­">ì„œìš¸ì—­</option>
            </select>
        </div>
        <div class="form-group">
            <label>ìœ„ì¹˜ (ì§€ë„ì—ì„œ ì„ íƒ) *</label>
            <div class="coord-group">
                <input type="text" id="input-lat" placeholder="ìœ„ë„" readonly style="width: 35%;">
                <input type="text" id="input-lng" placeholder="ê²½ë„" readonly style="width: 35%;">
                <button class="coord-btn" id="btn-pick-loc" onclick="togglePickMode()">ğŸ—ºï¸ ì„ íƒ</button>
            </div>
        </div>
        <hr style="border: 0; border-top: 1px solid #eee; margin: 15px 0;">
        <label style="font-size:12px; color:#888; display:block; margin-bottom:10px;">ğŸ‘‡ ì„ ë°° ì •ë³´ (ì„ íƒì‚¬í•­)</label>
        <div class="form-group">
            <label>ì´ë¦„</label>
            <input type="text" id="input-name" placeholder="ì˜ˆ: í™ê¸¸ë™">
        </div>
        <div class="form-group" style="display:flex; gap:10px;">
            <div style="flex:1;">
                <label>ê¸°ìˆ˜ (CP)</label>
                <input type="number" id="input-cp" placeholder="ì˜ˆ: 30">
            </div>
            <div style="flex:2;">
                <label>ì „í™”ë²ˆí˜¸</label>
                <input type="text" id="input-phone" placeholder="010-0000-0000">
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn-cancel" onclick="closeModal()">ì·¨ì†Œ</button>
            <button class="btn-save" onclick="saveData()">ì €ì¥</button>
        </div>
    </div>
</div>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
<!-- Leaflet Geocoder JS -->
<script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>

<script>
    // ë¹„ë°€ë²ˆí˜¸ ì²´í¬ í•¨ìˆ˜ ë° ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì œê±°ë¨

    var map = L.map('map').setView([37.53, 127.00], 11);
    
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    }).addTo(map);

    // ì¥ì†Œ ê²€ìƒ‰
    var searchMarker = null;
    window.removeSearchMarker = function() {
        if (searchMarker) { map.removeLayer(searchMarker); searchMarker = null; }
    };
    L.Control.geocoder({
        defaultMarkGeocode: false,
        position: 'topright',
        placeholder: 'ì¥ì†Œ ê²€ìƒ‰',
        errorMessage: 'ê²°ê³¼ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'
    }).on('markgeocode', function(e) {
        if (searchMarker) map.removeLayer(searchMarker);
        var bbox = e.geocode.bbox;
        if (bbox) map.fitBounds(bbox); else map.setView(e.geocode.center, 14);
        searchMarker = L.marker(e.geocode.center).addTo(map);
        var popupContent = `
            <div style="text-align: center; min-width: 150px;">
                <span style="font-weight:bold; display:block; margin-bottom:8px; font-size:14px; color:#333;">ğŸ“ ${e.geocode.name}</span>
                <button onclick="removeSearchMarker()" style="padding: 5px 10px; cursor: pointer; background-color: #ff4444; color: white; border: none; border-radius: 4px; font-size: 12px; font-family: 'Noto Sans KR', sans-serif;">í•€ ì‚­ì œ ğŸ—‘ï¸</button>
            </div>`;
        searchMarker.bindPopup(popupContent).openPopup();
    }).addTo(map);

    // 3. íšŒì‚¬ ë°ì´í„° ì •ì˜
    let companies = [
        // --- CBD (ë„ì‹¬) ---
        { name: "ê¸ˆìœµìœ„ì›íšŒ", group: "CBD", lat: 37.5749, lng: 126.9750, desc: "ì¢…ë¡œêµ¬ (ì •ë¶€ì„œìš¸ì²­ì‚¬)", color: "#E63946" },
        { name: "IBKê¸°ì—…ì€í–‰", group: "CBD", lat: 37.5662, lng: 126.9880, desc: "ì¤‘êµ¬ (ì„ì§€ë¡œ ë³¸ì )", color: "#E63946" },
        { name: "SKT", group: "CBD", lat: 37.5664, lng: 126.9850, desc: "ì¤‘êµ¬ (Tíƒ€ì›Œ)", color: "#E63946" },
        { name: "ì‚¼ì„±ì¹´ë“œ", group: "CBD", lat: 37.5626, lng: 126.9760, desc: "ì¤‘êµ¬ (ì‚¼ì„±ë³¸ê´€)", color: "#E63946" },
        { name: "í˜„ëŒ€í•´ìƒí™”ì¬ë³´í—˜", group: "CBD", lat: 37.5705, lng: 126.9767, desc: "ì¢…ë¡œêµ¬ (ê´‘í™”ë¬¸)", color: "#E63946" },
        { name: "LGìƒí™œê±´ê°•", group: "CBD", lat: 37.5703, lng: 126.9749, desc: "ì¢…ë¡œêµ¬ (ê´‘í™”ë¬¸ LGë¹Œë”©)", color: "#E63946" },
        { name: "Electrolux", group: "CBD", lat: 37.5661, lng: 126.9877, desc: "ì¤‘êµ¬ (íŒŒì¸ì—ë¹„ë‰´)", color: "#E63946" },
        { name: "ë¯¸ë˜ì—ì…‹ì¦ê¶Œ", group: "CBD", lat: 37.5673, lng: 126.9846, desc: "ì¤‘êµ¬ (ì„¼í„°ì›)", color: "#E63946" },
        { name: "í•œêµ­ê´€ê´‘ê³µì‚¬", group: "CBD", lat: 37.5682, lng: 126.9818, desc: "ì¤‘êµ¬ (ì„œìš¸ì„¼í„°)", color: "#E63946" },

        // --- GBD (ê°•ë‚¨) ---
        { name: "ì‚¼ì„±ìƒëª…/í™”ì¬", group: "GBD", lat: 37.4973, lng: 127.0274, desc: "ì„œì´ˆêµ¬ (ì‚¼ì„±íƒ€ìš´)", color: "#0066FF" },
        { name: "ì‚¼ì„±í™”ì¬í•´ìƒë³´í—˜", group: "GBD", lat: 37.4973, lng: 127.0274, desc: "ì„œì´ˆêµ¬ (ì‚¼ì„±íƒ€ìš´)", color: "#0066FF" }, 
        { name: "DBì†í•´ë³´í—˜", group: "GBD", lat: 37.5057, lng: 127.0544, desc: "ê°•ë‚¨êµ¬ (DBê¸ˆìœµì„¼í„°)", color: "#0066FF" },
        { name: "GSë¦¬í…Œì¼", group: "GBD", lat: 37.5019, lng: 127.0372, desc: "ê°•ë‚¨êµ¬ (GSíƒ€ì›Œ)", color: "#0066FF" },
        { name: "ì´ì¦ˆí”¼ì— í”¼", group: "GBD", lat: 37.4878, lng: 126.9930, desc: "ì„œì´ˆêµ¬ (ë°©ë°°ë™)", color: "#0066FF" },
        { name: "ëŒ€ì›…ì œì•½", group: "GBD", lat: 37.5133, lng: 127.0594, desc: "ê°•ë‚¨êµ¬ (ì‚¼ì„±ë™)", color: "#0066FF" },
        { name: "í† ìŠ¤ë±…í¬", group: "GBD", lat: 37.5004, lng: 127.0326, desc: "ê°•ë‚¨êµ¬ (ì—­ì‚¼ë™)", color: "#0066FF" },

        // --- YBD (ì—¬ì˜ë„) ---
        { name: "í•œì˜íšŒê³„ë²•ì¸", group: "YBD", lat: 37.5197, lng: 126.9290, desc: "ì˜ë“±í¬êµ¬ (íƒœì˜ë¹Œë”©)", color: "#2A9D8F" },
        { name: "ë¡¯ë°í™ˆì‡¼í•‘", group: "YBD", lat: 37.5375, lng: 126.8920, desc: "ì˜ë“±í¬êµ¬ (ì–‘í‰ë™)", color: "#2A9D8F" },
        { name: "LG ì „ì", group: "YBD", lat: 37.5276, lng: 126.9292, desc: "ì˜ë“±í¬êµ¬ (LGíŠ¸ìœˆíƒ€ì›Œ)", color: "#2A9D8F" },
        { name: "ë”œë¡œì´íŠ¸", group: "YBD", lat: 37.5255, lng: 126.9255, desc: "ì˜ë“±í¬êµ¬ (One IFC)", color: "#2A9D8F" },

        // --- ê¸°íƒ€ ì„œìš¸ ---
        { name: "ìœ í•œí‚´ë²Œë¦¬", group: "ê¸°íƒ€(ì„œìš¸)", lat: 37.5125, lng: 127.1025, desc: "ì†¡íŒŒêµ¬ (ë¡¯ë°ì›”ë“œíƒ€ì›Œ)", color: "#F4A261" },
        { name: "ìˆ˜í˜‘ì¤‘ì•™íšŒ", group: "ê¸°íƒ€(ì„œìš¸)", lat: 37.5140, lng: 127.1040, desc: "ì†¡íŒŒêµ¬ (ì ì‹¤)", color: "#F4A261" },
        { name: "ì¿ íŒ¡ì• ì¦ˆ", group: "ê¸°íƒ€(ì„œìš¸)", lat: 37.5156, lng: 127.1011, desc: "ì†¡íŒŒêµ¬ (íƒ€ì›Œ730)", color: "#F4A261" },
        { name: "í•œêµ­ì¡´ìŠ¨ì•¤ë“œì¡´ìŠ¨", group: "ê¸°íƒ€(ì„œìš¸)", lat: 37.5284, lng: 126.9685, desc: "ìš©ì‚°êµ¬ (LSìš©ì‚°íƒ€ì›Œ)", color: "#F4A261" },
        { name: "ë„¥ì„¼íƒ€ì´ì–´", group: "ê¸°íƒ€(ì„œìš¸)", lat: 37.5630, lng: 126.8375, desc: "ê°•ì„œêµ¬ (ë§ˆê³¡)", color: "#F4A261" },
        { name: "ì‹ ìš©ë³´ì¦ê¸°ê¸ˆ", group: "ê¸°íƒ€(ì„œìš¸)", lat: 37.5424, lng: 126.9507, desc: "ë§ˆí¬êµ¬ (ê³µë•)", color: "#F4A261" },
        { name: "í˜„ëŒ€ê¸€ë¡œë¹„ìŠ¤", group: "ê¸°íƒ€(ì„œìš¸)", lat: 37.5446, lng: 127.0436, desc: "ì„±ë™êµ¬ (ì„±ìˆ˜)", color: "#F4A261" },

        // --- ê²½ê¸°ê¶Œ ---
        { name: "ASML Korea", group: "ê²½ê¸°ê¶Œ", lat: 37.2190, lng: 127.0900, desc: "í™”ì„±ì‹œ (ë™íƒ„)", color: "#9B5DE5" },
        { name: "SK E&S ë‚˜ë˜ì—ë„ˆì§€", group: "ê²½ê¸°ê¶Œ", lat: 37.5700, lng: 127.1850, desc: "í•˜ë‚¨ì‹œ (ë¯¸ì‚¬)", color: "#9B5DE5" },

        // --- ëœë“œë§ˆí¬ ---
        { name: "ì„œìš¸ì—­", group: "ì„œìš¸ì—­", lat: 37.5559, lng: 126.9723, desc: "êµí†µ í—ˆë¸Œ / KTX ì¤‘ì‹¬", color: "#333333" }
    ];

    // ë§ˆì»¤ ê´€ë¦¬ìš© ë ˆì´ì–´ ê·¸ë£¹
    let markerLayerGroup = L.layerGroup().addTo(map);
    const markersRef = {};

    function updateMarkers(displayData) {
        markerLayerGroup.clearLayers();
        for (let key in markersRef) delete markersRef[key];

        companies.forEach(comp => {
            // í˜„ì¬ ë¦¬ìŠ¤íŠ¸(displayData)ì— í¬í•¨ëœ ë©¤ë²„ê°€ ìˆëŠ”ì§€ í™•ì¸
            const relevantMembers = displayData.filter(p => {
                if (!p.company) return false;
                if (comp.name === p.company) return true;
                if (comp.name.includes("/") && comp.name.includes(p.company)) return true;
                return false;
            });

            // í‘œì‹œ ì¡°ê±´: ê´€ë ¨ ë©¤ë²„ê°€ ìˆê±°ë‚˜, ì„œìš¸ì—­ì¸ ê²½ìš°
            if (relevantMembers.length > 0 || comp.group === "ì„œìš¸ì—­") {
                
                // íˆ¬ëª…ë„ ì„¤ì • ë¡œì§
                // ì°¸ì„ì ëª…ë‹¨(activeList)ì— í•´ë‹¹ íšŒì‚¬ì˜ ì‚¬ëŒì´ í•œ ëª…ë„ ì—†ìœ¼ë©´(ì¦‰, ë³´ë¥˜ ì¸ì›ë§Œ ìˆìœ¼ë©´) ë°˜íˆ¬ëª… ì²˜ë¦¬
                let opacityStyle = "opacity: 1.0;";
                
                if (comp.group !== "ì„œìš¸ì—­") {
                    const hasActiveMembers = activeList.some(p => {
                        if (!p.company) return false;
                        if (comp.name === p.company) return true;
                        if (comp.name.includes("/") && comp.name.includes(p.company)) return true;
                        return false;
                    });

                    if (!hasActiveMembers) {
                        opacityStyle = "opacity: 0.7;"; // íˆ¬ëª…ë„ 70%ë¡œ ì¡°ì • (ë” ì˜ ë³´ì´ê²Œ)
                    }
                }

                var icon = L.divIcon({
                    className: 'custom-div-icon',
                    html: `<div style="width: 100%; height: 100%; display: flex; justify-content: center; align-items: center; cursor: pointer; ${opacityStyle}">
                                <div class="custom-marker" style="background-color: ${comp.color}; width: 16px; height: 16px;"></div>
                           </div>`,
                    iconSize: [30, 30],
                    iconAnchor: [15, 15]
                });
                var marker = L.marker([comp.lat, comp.lng], { icon: icon });
                
                var membersHtml = '';
                if (relevantMembers.length > 0) {
                    membersHtml = '<div class="popup-members">';
                    relevantMembers.forEach(m => {
                        // ë³´ë¥˜ ì¸ì›ì€ íƒœê·¸ë¡œ í‘œì‹œ
                        const isPending = pendingList.includes(m);
                        const tag = isPending ? ' <span style="font-size:10px; background:#ddd; padding:1px 4px; border-radius:3px;">ë³´ë¥˜</span>' : '';
                        membersHtml += `<span class="member-row">ğŸ§‘â€ğŸ’¼ CP${m.cp} ${m.name}${tag}</span>`;
                    });
                    membersHtml += '</div>';
                }

                var popupContent = `<div>
                        <span class="popup-badge" style="background-color: ${comp.color}">${comp.group}</span>
                        <span class="popup-title">${comp.name}</span>
                        <span class="popup-desc">${comp.desc}</span>
                        ${membersHtml}
                    </div>`;
                marker.bindPopup(popupContent);
                markerLayerGroup.addLayer(marker);

                markersRef[comp.name] = marker;
                if (comp.name.includes("/")) {
                    comp.name.split("/").forEach(sub => markersRef[sub] = marker);
                }
            }
        });
    }

    // ë²”ë¡€
    var legend = L.control({ position: 'bottomright' });
    legend.onAdd = function (map) {
        var div = L.DomUtil.create('div', 'legend');
        div.innerHTML += '<span class="legend-title">ì—…ë¬´ì§€êµ¬ êµ¬ë¶„</span>';
        div.innerHTML += '<i style="background: #E63946"></i> CBD (ë„ì‹¬)<br>';
        div.innerHTML += '<i style="background: #0066FF"></i> GBD (ê°•ë‚¨)<br>';
        div.innerHTML += '<i style="background: #2A9D8F"></i> YBD (ì—¬ì˜ë„)<br>';
        div.innerHTML += '<i style="background: #F4A261"></i> ê¸°íƒ€ ì„œìš¸<br>';
        div.innerHTML += '<i style="background: #9B5DE5"></i> ê²½ê¸°ê¶Œ<br>';
        div.innerHTML += '<i style="background: #333333"></i> ì„œìš¸ì—­<br>';
        return div;
    };
    legend.addTo(map);

    // ë°ì´í„° íŒŒì‹± ë° ë¡œë“œ
    const nameToCompany = {
        "ê¹€ì˜ê·¼": "ê¸ˆìœµìœ„ì›íšŒ", "ì‹ ë™ìš±": "í•œêµ­ì¡´ìŠ¨ì•¤ë“œì¡´ìŠ¨", "ê¹€ë™ì§„": "ìœ í•œí‚´ë²Œë¦¬", 
        "ë…¸ê·œì² ": "ì‚¼ì„±ìƒëª…/í™”ì¬", "í™©ì„ í˜¸": "ì‚¼ì„±ì¹´ë“œ", "ë°•ì§„ë ¨": "ì´ì¦ˆí”¼ì— í”¼", 
        "ë¥˜ì‹œì§„": "SKT", "ë¥˜íƒœê´‘": "ASML Korea", "ê¹€ë¯¼ìš°": "DBì†í•´ë³´í—˜", 
        "ê¹€ê±´ìš°": "ë¡¯ë°í™ˆì‡¼í•‘", "ì„œë´‰ì„­": "SK E&S ë‚˜ë˜ì—ë„ˆì§€", "ìœ í˜œë¼": "IBKê¸°ì—…ì€í–‰", 
        "ì •ìˆ˜í˜": "í•œì˜íšŒê³„ë²•ì¸", "ìš°ì„±ê·œ": "ìˆ˜í˜‘ì¤‘ì•™íšŒ", "ë°±ì§€ì˜": "ì‚¼ì„±ìƒëª…/í™”ì¬", 
        "ì‹ ì˜ˆì§„": "í•œêµ­ì¡´ìŠ¨ì•¤ë“œì¡´ìŠ¨", "ì¡°ì€í˜œ": "ë„¥ì„¼íƒ€ì´ì–´", "ë¦¬ìˆ˜ì˜": "ì¿ íŒ¡ì• ì¦ˆ", 
        "ë°•í˜œì§„": "GSë¦¬í…Œì¼",
        "ì„ì˜ìš±": "ëŒ€ì›…ì œì•½", "ê¹€íƒœëŸ‰": "í˜„ëŒ€í•´ìƒí™”ì¬ë³´í—˜", "ì•ˆì •ì§„": "LG ì „ì",
        "ë¬¸ìƒì„": "LGìƒí™œê±´ê°•", "ìœ íƒœí›ˆ": "ì‹ ìš©ë³´ì¦ê¸°ê¸ˆ", 
        "ë°•ì°½í˜„": "í˜„ëŒ€ê¸€ë¡œë¹„ìŠ¤", "ê¹€ì§„ìš°": "í˜„ëŒ€ê¸€ë¡œë¹„ìŠ¤", "ê¹€ì˜ì¬": "í˜„ëŒ€ê¸€ë¡œë¹„ìŠ¤",
        "ê¹€ë¬¸ìˆ˜": "ì‚¼ì„±í™”ì¬í•´ìƒë³´í—˜", "ë°•ì„¸í˜„": "DBì†í•´ë³´í—˜",
        "ì´ìœ ì¤€": "Electrolux", "ë°±ë¯¼ì œ": "ë”œë¡œì´íŠ¸", "ì´ìš°ìµ": "ë¯¸ë˜ì—ì…‹ì¦ê¶Œ",
        "ê¹€ë¯¼ìˆ˜": "í† ìŠ¤ë±…í¬", "ê¹€ì˜ê²½": "í•œêµ­ê´€ê´‘ê³µì‚¬"
    };

    const activeRaw = [
        "ê¹€ì˜ê·¼9010-4552-3557ì„œìš¸", "ì‹ ë™ìš±10010-4105-0141ì„œìš¸", "ê¹€ë™ì§„14010-9239-8543ì„œìš¸",
        "ë…¸ê·œì² 18010-5110-8620ë™íƒ„", "í™ì€ì„±21010-6587-3652ë¶€ì‚°", "í™©ì„ í˜¸21010-4069-0349ì„œìš¸",
        "ë°•ì§„ë ¨25010-9800-7567ì„œìš¸", "ë¥˜ì‹œì§„25010-5145-4398ì„œìš¸", "ë¥˜íƒœê´‘31010-4566-6988ë™íƒ„",
        "ê¹€ë¯¼ìš°32010-3277-0834ì„œìš¸", "ê¹€ê±´ìš°37010-3731-5172ì„œìš¸", "ì„œë´‰ì„­37010-7563-1474ì„œìš¸",
        "ì˜ˆë¯¼í•´37010-9280-7440", "ìœ í˜œë¼38010-3157-5189ì„œìš¸", "ì •ìˆ˜í˜38010-2327-7041ì„œìš¸",
        "ìš°ì„±ê·œ38010-3363-8594", "ë°±ì§€ì˜38010-9288-0392ì„œìš¸", "ì‹ ì˜ˆì§„38010-8578-5342ì„œìš¸",
        "ê¹€ë¯¸ì„±39010-6546-3219", "ì¡°ì€í˜œ41010-5027-1402ë¶€ì‚° ëª…ì§€", "ì„œìœ ì§„42010-4132-3914",
        "ê¹€ì£¼ì—°42010-9296-1272", "ë¦¬ìˆ˜ì˜42010-6284-9295", "ë°•í˜œì§„43010-5606-6540",
        "ê¹€ìŠ¹ë¯¼44010-3533-4738", "ë°•ì‚°í•˜44010-4139-7821í™•ì¸í•„ìš”", "ì´í˜„ì§€44010-2544-9371",
        "ë‚¨ë‹¤ì€45010-9985-3824", "ì†ì„ì±„46010-8477-0347"
    ];

    const pendingRaw = [
        "ì„ì˜ìš±1010-4707-6806", "ì•ˆì •ì§„9010-2203-3428", "ê¹€íƒœëŸ‰9010-2585-3538",
        "ë¬¸ìƒì„13010-2446-9214", "ë°•ì°½í˜„19010-2468-0887", "ìœ íƒœí›ˆ19010-6421-3349",
        "ê¹€ë¬¸ìˆ˜21ì „í™”ë²ˆí˜¸ ë°”ë€œ", "ë°•ì„¸í˜„21010-8590-1213", "ì´ìœ ì¤€22010-6519-6599",
        "ë°±ë¯¼ì œ29010-5179-3550", "ì´ìš°ìµ30010-4586-7270", "ì •í¬ì„ 33010-5586-6193",
        "ê¹€ì§„ìš°35010-5170-6062", "ê¹€ë¯¼ìˆ˜37010-7462-0007", "ê¹€ì˜ê²½38010-5159-7227",
        "ê¹€ì˜ì¬39010-5873-3397"
    ];

    let activeList = []; 
    let pendingList = [];

    function parseData(rawData) {
        return rawData.map(item => {
            const match = item.match(/^([ê°€-í£]+)(\d+)(.*)$/);
            if (!match) return { name: item, cp: "", phone: "", loc: "", company: "" };
            
            const name = match[1];
            let cp = match[2];
            let rest = match[3];

            if (cp.length >= 3 && cp.endsWith('010')) {
                cp = cp.slice(0, -3);
                rest = '010' + rest;
            }

            let phone = "";
            let loc = "";

            const phoneMatch = rest.match(/(\d{3}-\d{3,4}-\d{4})(.*)/);
            if (phoneMatch) {
                phone = phoneMatch[1];
                loc = phoneMatch[2].trim();
            } else {
                loc = rest;
            }

            const company = nameToCompany[name] || "";
            return { name, cp, phone, loc, company };
        });
    }

    activeList = parseData(activeRaw);
    pendingList = parseData(pendingRaw);

    // --- í† ê¸€ ë° ë¦¬ìŠ¤íŠ¸ ë Œë”ë§ ë¡œì§ ---
    let isPendingShown = false;

    function togglePending(show) {
        if (typeof show === 'undefined') show = !isPendingShown; // ì¸ì ì—†ìœ¼ë©´ í† ê¸€
        isPendingShown = show;
        
        // UI ë™ê¸°í™”
        document.getElementById('chk-pending').checked = show;
        const floatBtn = document.getElementById('btn-toggle-pending');
        
        if(show) {
            floatBtn.classList.add('active');
            // ì²´í¬ ì•„ì´ì½˜ìœ¼ë¡œ ë³€ê²½
            floatBtn.innerHTML = `
                <svg viewBox="0 0 24 24"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg> 
                ë³´ë¥˜ ìˆ¨ê¸°ê¸°
            `;
        } else {
            floatBtn.classList.remove('active');
            // í”ŒëŸ¬ìŠ¤ ì•„ì´ì½˜ìœ¼ë¡œ ë³€ê²½
            floatBtn.innerHTML = `
                <svg viewBox="0 0 24 24"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg> 
                ë³´ë¥˜ í¬í•¨
            `;
        }

        renderList();
    }

    function renderList() {
        const listContainer = document.getElementById('list-content');
        listContainer.innerHTML = "";
        
        // ê¸°ë³¸: ì°¸ì„ì(active), ë³´ë¥˜ í¬í•¨ ì‹œ: +ë³´ë¥˜ì(pending)
        let displayList = [...activeList];
        if (isPendingShown) {
            displayList = [...activeList, ...pendingList];
        }

        updateMarkers(displayList);

        displayList.forEach(p => {
            const hasCompany = p.company && markersRef[p.company];
            const isPending = pendingList.includes(p); // ë³´ë¥˜ ëª…ë‹¨ ì—¬ë¶€ í™•ì¸

            const card = document.createElement('div');
            card.className = 'person-card' + (isPending ? ' pending-card' : '');
            
            if (hasCompany) {
                card.onclick = function() {
                    const m = markersRef[p.company];
                    if (m) {
                        map.setView(m.getLatLng(), 15);
                        m.openPopup();
                    }
                };
            }

            let companyHtml = p.company ? `<span class="company-tag">ğŸ¢ ${p.company}</span>` : '';
            if (!p.company && !isPending && p.loc) companyHtml = `<span class="company-tag" style="background:#f5f5f5; color:#666;">ğŸ“ ${p.loc}</span>`;
            
            let phoneHtml = p.phone ? `<span class="phone-text">${p.phone}</span>` : `<span style="color:#888">${p.loc}</span>`;
            let locHtml = (p.phone && p.loc) ? `<span class="loc-tag">${p.loc}</span>` : '';
            
            // ë³´ë¥˜ì í‘œì‹œ
            let badgeHtml = isPending ? '<span style="font-size:11px; color:#666; background:#eee; padding:2px 5px; border-radius:4px; margin-left:5px;">ë³´ë¥˜</span>' : '';

            card.innerHTML = `
                <div class="card-header">
                    <span class="name">${p.name}${badgeHtml}</span>
                    <span class="cp-badge">CP${p.cp.padStart(2,'0')}</span>
                </div>
                <div class="info-row">
                    <span class="info-icon">ğŸ“</span>
                    ${phoneHtml}
                    ${locHtml}
                </div>
                ${companyHtml}
            `;
            listContainer.appendChild(card);
        });
    }

    // ì´ˆê¸° ì‹¤í–‰
    renderList();

    // ì‚¬ì´ë“œë°” í† ê¸€
    function toggleSidebar(show) {
        const sidebar = document.getElementById('sidebar');
        const showBtn = document.getElementById('btn-show-list');
        const toggleBtn = document.getElementById('btn-toggle-pending');
        
        if (show) {
            sidebar.style.display = 'flex';
            showBtn.style.display = 'none';
            toggleBtn.style.top = '115px'; // ì‚¬ì´ë“œë°” ì—´ë¦¬ë©´ ë²„íŠ¼ ìœ„ì¹˜ ì¡°ì • í•„ìš”ì‹œ (í˜„ì¬ëŠ” ê³ ì •)
        } else {
            sidebar.style.display = 'none';
            showBtn.style.display = 'block';
            toggleBtn.style.top = '115px';
        }
        setTimeout(() => { map.invalidateSize(); }, 100);
    }

    // ëª¨ë‹¬ ê´€ë ¨ í•¨ìˆ˜ë“¤
    let pickMode = false;
    let tempMarker = null;

    function openModal() { document.getElementById('modal-overlay').style.display = 'flex'; }
    function closeModal() {
        document.getElementById('modal-overlay').style.display = 'none';
        pickMode = false;
        document.getElementById('btn-pick-loc').classList.remove('picking');
        document.getElementById('btn-pick-loc').innerText = 'ğŸ—ºï¸ ì„ íƒ';
        if(tempMarker) { map.removeLayer(tempMarker); tempMarker = null; }
        // ì…ë ¥ ì´ˆê¸°í™” ìƒëµ
    }
    
    function togglePickMode() {
        pickMode = !pickMode;
        const btn = document.getElementById('btn-pick-loc');
        if (pickMode) {
            btn.classList.add('picking');
            btn.innerText = 'ì§€ë„ í´ë¦­í•˜ì„¸ìš”';
            document.getElementById('add-modal').style.opacity = '0.2';
        } else {
            btn.classList.remove('picking');
            btn.innerText = 'ğŸ—ºï¸ ì„ íƒ';
            document.getElementById('add-modal').style.opacity = '1';
        }
    }

    map.on('click', function(e) {
        if (!pickMode) return;
        const lat = e.latlng.lat.toFixed(6);
        const lng = e.latlng.lng.toFixed(6);
        document.getElementById('input-lat').value = lat;
        document.getElementById('input-lng').value = lng;
        if (tempMarker) map.removeLayer(tempMarker);
        tempMarker = L.marker([lat, lng]).addTo(map);
        togglePickMode();
    });

    function saveData() {
        const companyName = document.getElementById('input-company').value.trim();
        const group = document.getElementById('input-group').value;
        const lat = document.getElementById('input-lat').value;
        const lng = document.getElementById('input-lng').value;
        const name = document.getElementById('input-name').value.trim();
        const cp = document.getElementById('input-cp').value.trim();
        const phone = document.getElementById('input-phone').value.trim();

        if (!companyName || !lat || !lng) {
            alert("íšŒì‚¬ëª…ê³¼ ìœ„ì¹˜ëŠ” í•„ìˆ˜ì…ë‹ˆë‹¤!");
            return;
        }

        let color = "#333";
        if(group === "CBD") color = "#E63946";
        else if(group === "GBD") color = "#0066FF";
        else if(group === "YBD") color = "#2A9D8F";
        else if(group === "ê¸°íƒ€(ì„œìš¸)") color = "#F4A261";
        else if(group === "ê²½ê¸°ê¶Œ") color = "#9B5DE5";

        const newCompany = {
            name: companyName, group: group, lat: parseFloat(lat), lng: parseFloat(lng),
            desc: "ì‚¬ìš©ì ì¶”ê°€ ì¥ì†Œ", color: color
        };
        companies.push(newCompany);

        if (name) {
            const newPerson = { name: name, cp: cp, phone: phone, loc: "ì„œìš¸", company: companyName };
            activeList.unshift(newPerson); // ì‹ ê·œ ë“±ë¡ì€ ì°¸ì„ìë¡œ ê°„ì£¼
            renderList();
        } else {
            // ì¸ì› ì—†ì´ ì¥ì†Œë§Œ
            renderList();
        }
        closeModal();
        alert("ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!");
    }
</script>

</body>
</html>
