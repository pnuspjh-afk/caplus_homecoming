<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì„œìš¸ ì£¼ìš” ê¸°ì—… ë³¸ì‚¬/ì‚¬ì˜¥ ìœ„ì¹˜ ì§€ë„ & ì„ ë°° ëª…ë‹¨</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    
    <style>
        body { margin: 0; padding: 0; font-family: 'Noto Sans KR', sans-serif; display: flex; height: 100vh; overflow: hidden; }
        
        /* ì™¼ìª½ ì§€ë„ ì˜ì—­ */
        #map-container { flex: 3; position: relative; transition: flex 0.3s ease; }
        #map { height: 100%; width: 100%; }
        
        /* ê²€ìƒ‰ì°½ ìŠ¤íƒ€ì¼ */
        #search-box { position: absolute; top: 20px; left: 60px; z-index: 1100; width: 340px; }
        #search-input { width: 100%; padding: 12px 16px; border-radius: 12px; border: 2px solid #0066FF; box-shadow: 0 4px 12px rgba(0,0,0,0.15); font-size: 14px; outline: none; box-sizing: border-box; }
        #search-results { position: absolute; top: 52px; left: 0; width: 100%; background: white; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); max-height: 400px; overflow-y: auto; display: none; }
        .search-item { padding: 12px 16px; border-bottom: 1px solid #f0f0f0; cursor: pointer; display: flex; flex-direction: column; gap: 2px; }
        .search-item:hover { background-color: #f8faff; }
        
        .badge { display: inline-block; padding: 2px 6px; border-radius: 4px; font-size: 10px; font-weight: bold; margin-right: 6px; }
        .badge-company { background: #eef4ff; color: #0066FF; }
        .badge-person { background: #333; color: white; }
        .badge-place { background: #4caf50; color: white; }
        .badge-pending { background: #ffeded; color: #e63946; border: 1px solid #ffcfcf; }

        /* ê·¸ë£¹í•‘ ì •ë³´ (ë²”ë¡€) */
        #legend { position: absolute; bottom: 30px; left: 20px; z-index: 1100; background: white; padding: 12px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.2); font-size: 12px; line-height: 1.8; }
        .legend-item { display: flex; align-items: center; gap: 8px; margin-bottom: 4px; }
        .legend-color { width: 12px; height: 12px; border-radius: 50%; border: 1px solid #fff; box-shadow: 0 0 2px rgba(0,0,0,0.3); }

        /* ë¹„ë°€ë²ˆí˜¸ ì ê¸ˆ ì˜¤ë²„ë ˆì´ */
        #login-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255, 255, 255, 0.8); backdrop-filter: blur(15px); z-index: 5000; display: flex; justify-content: center; align-items: center; flex-direction: column; }
        .login-box { background: white; padding: 40px; border-radius: 16px; box-shadow: 0 15px 35px rgba(0,0,0,0.1); text-align: center; width: 360px; max-width: 90%; }
        .login-box h2 { color: #003399; margin-bottom: 30px; font-size: 28px; letter-spacing: 2px; font-weight: 800; }
        .login-box input { width: 100%; padding: 14px; margin-bottom: 15px; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; text-align: center; outline: none; box-sizing: border-box; }
        .login-box button { width: 100%; padding: 14px; background: #003399; color: white; border: none; border-radius: 8px; font-size: 16px; cursor: pointer; box-sizing: border-box; }
        .error-msg { color: #E63946; font-size: 13px; margin-top: 10px; display: none; }

        /* ì‚¬ì´ë“œë°” */
        #sidebar { flex: 1; min-width: 340px; background: #f8f9fa; border-left: 1px solid #ddd; display: flex; flex-direction: column; z-index: 1000; }
        #list-header { display: flex; justify-content: space-between; align-items: center; padding: 20px 15px; background: white; border-bottom: 1px solid #eee; }
        #list-content { flex: 1; overflow-y: auto; padding: 15px; }
        
        .person-card { background: white; padding: 15px; border-radius: 8px; margin-bottom: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); border: 1px solid #eee; cursor: pointer; transition: all 0.2s; }
        .person-card.pending { border-left: 4px solid #e63946; }
        .person-card:hover { border-color: #0066FF; transform: translateY(-2px); }
        
        .btn-status-change { margin-top: 10px; width: 100%; padding: 8px; font-size: 12px; background: #eef4ff; border: 1px solid #0066FF; color: #0066FF; border-radius: 6px; cursor: pointer; font-weight: bold; }
        .btn-status-change:hover { background: #0066FF; color white; }

        .map-float-btn { position: absolute; left: 10px; z-index: 1000; background: white; border: none; border-radius: 24px; padding: 10px 16px; cursor: pointer; font-size: 14px; box-shadow: 0 2px 6px rgba(0,0,0,0.3); }
        #btn-show-list { top: 85px; display: none; }
        #btn-toggle-pending { top: 135px; }

        /* íŒì—… ìŠ¤íƒ€ì¼ */
        .popup-title { font-weight: bold; font-size: 16px; display: block; margin-bottom: 4px; }
        .popup-members { background-color: #f8f9fa; border-top: 1px solid #eee; padding-top: 8px; margin-top: 8px; font-size: 13px; }
    </style>
</head>
<body>

<!-- ë¹„ë°€ë²ˆí˜¸ ì˜¤ë²„ë ˆì´ -->
<div id="login-overlay">
    <div class="login-box">
        <h2>CAPLUS</h2>
        <input type="password" id="pw-input" placeholder="ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”" onkeypress="if(event.keyCode==13) checkPassword()">
        <button onclick="checkPassword()">ì…ì¥í•˜ê¸°</button>
        <div id="pw-error" class="error-msg">ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</div>
    </div>
</div>

<div id="map-container">
    <div id="search-box">
        <input type="text" id="search-input" placeholder="ê¸°ì—…, ì„ ë°° ì´ë¦„ í˜¹ì€ ì„œìš¸ ì¥ì†Œ ê²€ìƒ‰..." autocomplete="off">
        <div id="search-results"></div>
    </div>
    <div id="map"></div>
    <div id="legend">
        <div style="font-weight: bold; margin-bottom: 8px; border-bottom: 1px solid #eee; padding-bottom: 4px;">êµ¬ì—­ë³„ ë¶„ë¥˜</div>
        <div class="legend-item"><div class="legend-color" style="background:#000000"></div> ì„œìš¸ì—­</div>
        <div class="legend-item"><div class="legend-color" style="background:#E63946"></div> CBD (ë„ì‹¬ê¶Œ)</div>
        <div class="legend-item"><div class="legend-color" style="background:#0066FF"></div> GBD (ê°•ë‚¨ê¶Œ)</div>
        <div class="legend-item"><div class="legend-color" style="background:#2A9D8F"></div> YBD (ì—¬ì˜ë„ê¶Œ)</div>
        <div class="legend-item"><div class="legend-color" style="background:#F4A261"></div> ê¸°íƒ€</div>
        <div class="legend-item"><div class="legend-color" style="background:#9B5DE5"></div> ê²½ê¸°/ì™¸ê³½</div>
    </div>
    <button id="btn-show-list" class="map-float-btn" onclick="toggleSidebar(true)">ëª…ë‹¨ ë³´ê¸°</button>
    <button id="btn-toggle-pending" class="map-float-btn" onclick="togglePending(!isPendingShown)">ë³´ë¥˜ í¬í•¨ ë³´ê¸°</button>
</div>

<div id="sidebar">
    <div id="list-header">
        <span style="font-weight: bold; font-size: 18px; color: #333;">ì°¸ì„ ëª…ë‹¨</span>
        <button onclick="toggleSidebar(false)" style="background: none; border: none; font-size: 20px; cursor: pointer; color: #999;">âœ–</button>
    </div>
    <div id="list-content"></div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
    // ë°ì´í„° ë° ìƒíƒœ ê´€ë¦¬
    let activeList = [];
    let pendingList = [];
    let isPendingShown = false;
    let markersRef = {};
    let markerLayerGroup;
    let searchTimeout = null;
    let tempSearchMarker = null;

    const groupColors = { "CBD": "#E63946", "GBD": "#0066FF", "YBD": "#2A9D8F", "ê¸°íƒ€": "#F4A261", "ê²½ê¸°": "#9B5DE5" };

    const companies = [
        { name: "ê¸ˆìœµìœ„ì›íšŒ", group: "CBD", lat: 37.5749, lng: 126.9750 },
        { name: "IBKê¸°ì—…ì€í–‰", group: "CBD", lat: 37.5662, lng: 126.9880 },
        { name: "SKT", group: "CBD", lat: 37.5664, lng: 126.9850 },
        { name: "ì‚¼ì„±ì¹´ë“œ", group: "CBD", lat: 37.5626, lng: 126.9760 },
        { name: "í˜„ëŒ€í•´ìƒí™”ì¬ë³´í—˜", group: "CBD", lat: 37.5705, lng: 126.9767 },
        { name: "LGìƒí™œê±´ê°•", group: "CBD", lat: 37.5703, lng: 126.9749 },
        { name: "í•œêµ­ì¡´ìŠ¨ì•¤ë“œì¡´ìŠ¨", group: "ê¸°íƒ€", lat: 37.5284, lng: 126.9685 },
        { name: "ì‚¼ì„±ìƒëª…", group: "GBD", lat: 37.4973, lng: 127.0274 },
        { name: "ì‚¼ì„±í™”ì¬", group: "GBD", lat: 37.4950, lng: 127.0250 },
        { name: "DBì†í•´ë³´í—˜", group: "GBD", lat: 37.5057, lng: 127.0544 },
        { name: "GSë¦¬í…Œì¼", group: "GBD", lat: 37.5019, lng: 127.0372 },
        { name: "ì´ì¦ˆí”¼ì— í”¼", group: "GBD", lat: 37.4854, lng: 126.9922 },
        { name: "í•œì˜íšŒê³„ë²•ì¸", group: "YBD", lat: 37.5197, lng: 126.9290 },
        { name: "ë¡¯ë°í™ˆì‡¼í•‘", group: "YBD", lat: 37.5375, lng: 126.8920 },
        { name: "ìœ í•œí‚´ë²Œë¦¬", group: "ê¸°íƒ€", lat: 37.5125, lng: 127.1025 },
        { name: "ìˆ˜í˜‘ì¤‘ì•™íšŒ", group: "ê¸°íƒ€", lat: 37.5173, lng: 127.1294 },
        { name: "ë„¥ì„¼íƒ€ì´ì–´", group: "ê¸°íƒ€", lat: 37.5583, lng: 126.8277 },
        { name: "ì¿ íŒ¡ì• ì¦ˆ", group: "ê¸°íƒ€", lat: 37.5150, lng: 127.1030 },
        { name: "ASML Korea", group: "ê²½ê¸°", lat: 37.2190, lng: 127.0900 },
        { name: "SK E&S ë‚˜ë˜ì—ë„ˆì§€ì„œë¹„ìŠ¤", group: "ê²½ê¸°", lat: 37.5504, lng: 127.1901 },
        { name: "ëŒ€ì›…ì œì•½", group: "GBD", lat: 37.5132, lng: 127.0601 },
        { name: "LGì „ì", group: "YBD", lat: 37.5259, lng: 126.9274 },
        { name: "ë¯¸ë˜ì—ì…‹ì¦ê¶Œ", group: "CBD", lat: 37.5647, lng: 126.9839 },
        { name: "í† ìŠ¤ë±…í¬", group: "GBD", lat: 37.5029, lng: 127.0374 },
        { name: "í•œêµ­ê´€ê´‘ê³µì‚¬", group: "ê²½ê¸°", lat: 37.3333, lng: 127.1111 },
        { name: "ì‹ ìš©ë³´ì¦ê¸°ê¸ˆ", group: "CBD", lat: 37.5520, lng: 126.9530 },
        { name: "í˜„ëŒ€ê¸€ë¡œë¹„ìŠ¤", group: "GBD", lat: 37.5250, lng: 127.0420 },
        { name: "Electrolux", group: "CBD", lat: 37.5600, lng: 126.9860 },
        { name: "ë”œë¡œì´íŠ¸", group: "YBD", lat: 37.5250, lng: 126.9240 }
    ];

    const initialData = {
        active: ["ê¹€ì˜ê·¼9", "ì‹ ë™ìš±10", "ê¹€ë™ì§„14", "ë…¸ê·œì² 18", "í™ì€ì„±21", "í™©ì„ í˜¸21", "ë°•ì§„ë ¨25", "ë¥˜ì‹œì§„25", "ë¥˜íƒœê´‘31", "ê¹€ë¯¼ìš°32", "ê¹€ê±´ìš°37", "ì„œë´‰ì„­37", "ì˜ˆë¯¼í•´37", "ìœ í˜œë¼38", "ì •ìˆ˜í˜38", "ìš°ì„±ê·œ38", "ë°±ì§€ì˜38", "ì‹ ì˜ˆì§„38", "ê¹€ë¯¸ì„±39", "ì¡°ì€í˜œ41", "ì„œìœ ì§„42", "ê¹€ì£¼ì—°42", "ë¦¬ìˆ˜ì˜42", "ë°•í˜œì§„43", "ê¹€ìŠ¹ë¯¼44", "ë°•ì‚°í•˜44", "ì´í˜„ì§€44", "ë‚¨ë‹¤ì€45", "ì†ì„ì±„46"],
        pending: ["ì„ì˜ìš±1", "ì•ˆì •ì§„9", "ê¹€íƒœëŸ‰9", "ë¬¸ìƒì„13", "ë°•ì°½í˜„19", "ìœ íƒœí›ˆ19", "ê¹€ë¬¸ìˆ˜21", "ë°•ì„¸í˜„21", "ì´ìœ ì¤€22", "ë°±ë¯¼ì œ29", "ì´ìš°ìµ30", "ì •í¬ì„ 33", "ê¹€ì§„ìš°35", "ê¹€ë¯¼ìˆ˜37", "ê¹€ì˜ê²½38", "ê¹€ì˜ì¬39"],
        map: {
            "ê¹€ì˜ê·¼":"ê¸ˆìœµìœ„ì›íšŒ",
            "ì‹ ë™ìš±":"í•œêµ­ì¡´ìŠ¨ì•¤ë“œì¡´ìŠ¨",
            "ì‹ ì˜ˆì§„":"í•œêµ­ì¡´ìŠ¨ì•¤ë“œì¡´ìŠ¨",
            "ê¹€ë™ì§„":"ìœ í•œí‚´ë²Œë¦¬",
            "ë…¸ê·œì² ":"ì‚¼ì„±í™”ì¬",
            "í™©ì„ í˜¸":"ì‚¼ì„±ì¹´ë“œ",
            "ë°•ì§„ë ¨":"ì´ì¦ˆí”¼ì— í”¼",
            "ë¥˜ì‹œì§„":"SKT",
            "í™ì€ì„±":"ë¯¸ë“±ë¡",
            "ë¥˜íƒœê´‘":"ASML Korea",
            "ê¹€ë¯¼ìš°":"DBì†í•´ë³´í—˜",
            "ê¹€ê±´ìš°":"ë¡¯ë°í™ˆì‡¼í•‘",
            "ì„œë´‰ì„­":"SK E&S ë‚˜ë˜ì—ë„ˆì§€ì„œë¹„ìŠ¤",
            "ìœ í˜œë¼":"IBKê¸°ì—…ì€í–‰",
            "ì •ìˆ˜í˜":"í•œì˜íšŒê³„ë²•ì¸",
            "ìš°ì„±ê·œ":"ìˆ˜í˜‘ì¤‘ì•™íšŒ",
            "ë°±ì§€ì˜":"ì‚¼ì„±ìƒëª…",
            "ì¡°ì€í˜œ":"ë„¥ì„¼íƒ€ì´ì–´",
            "ë¦¬ìˆ˜ì˜":"ì¿ íŒ¡ì• ì¦ˆ",
            "ë°•í˜œì§„":"GSë¦¬í…Œì¼",
            "ì„ì˜ìš±":"ëŒ€ì›…ì œì•½",
            "ê¹€íƒœëŸ‰":"í˜„ëŒ€í•´ìƒí™”ì¬ë³´í—˜",
            "ì•ˆì •ì§„":"LGì „ì",
            "ë¬¸ìƒì„":"LGìƒí™œê±´ê°•",
            "ìœ íƒœí›ˆ":"ì‹ ìš©ë³´ì¦ê¸°ê¸ˆ",
            "ë°•ì°½í˜„":"í˜„ëŒ€ê¸€ë¡œë¹„ìŠ¤",
            "ê¹€ì§„ìš°":"í˜„ëŒ€ê¸€ë¡œë¹„ìŠ¤",
            "ê¹€ì˜ì¬":"í˜„ëŒ€ê¸€ë¡œë¹„ìŠ¤",
            "ê¹€ë¬¸ìˆ˜":"ì‚¼ì„±í™”ì¬",
            "ë°•ì„¸í˜„":"DBì†í•´ë³´í—˜",
            "ì´ìœ ì¤€":"Electrolux",
            "ë°±ë¯¼ì œ":"ë”œë¡œì´íŠ¸",
            "ì´ìš°ìµ":"ë¯¸ë˜ì—ì…‹ì¦ê¶Œ",
            "ê¹€ë¯¼ìˆ˜":"í† ìŠ¤ë±…í¬",
            "ê¹€ì˜ê²½":"í•œêµ­ê´€ê´‘ê³µì‚¬"
        }
    };

    var map = L.map('map').setView([37.5547, 126.9707], 12);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
    markerLayerGroup = L.layerGroup().addTo(map);

    function checkPassword() {
        if (document.getElementById('pw-input').value === '53zips') {
            document.getElementById('login-overlay').style.display = 'none';
        } else {
            document.getElementById('pw-error').style.display = 'block';
        }
    }

    function parseItem(item, status) {
        const m = item.match(/^([ê°€-í£a-zA-Z]+)(\d+)/);
        const name = m ? m[1] : item;
        const cp = parseInt(m ? m[2] : 0);
        const company = initialData.map[name] || "ë¯¸ë“±ë¡";
        return { name, cp, company, status, isMarkerCompany: companies.some(c => c.name === company) };
    }

    function promoteToActive(personName) {
        const idx = pendingList.findIndex(p => p.name === personName);
        if (idx > -1) {
            const person = pendingList.splice(idx, 1)[0];
            person.status = 'active';
            activeList.push(person);
            renderList();
        }
    }

    function updateMarkers(displayData) {
        markerLayerGroup.clearLayers();
        markersRef = {};
        
        // ì„œìš¸ì—­ ê±°ì 
        L.marker([37.5547, 126.9707], { icon: L.divIcon({ className: '', html: `<div style="background:#000; width:18px; height:18px; border:2px solid white; border-radius:50%; box-shadow:0 2px 5px rgba(0,0,0,0.5);"></div>`, iconSize: [22, 22] }) }).addTo(markerLayerGroup).bindPopup("<strong>ğŸ“ ì„œìš¸ì—­ (ê±°ì )</strong>");

        companies.forEach(comp => {
            const relevantMembers = displayData.filter(p => p.company === comp.name);
            if (relevantMembers.length > 0) {
                const hasActive = relevantMembers.some(m => m.status === 'active');
                const opacity = hasActive ? 1 : 0.6;
                const color = groupColors[comp.group] || "#333";
                
                const icon = L.divIcon({
                    className: '',
                    html: `<div style="background:${color}; width:16px; height:16px; border:2px solid white; border-radius:50%; box-shadow:0 2px 5px rgba(0,0,0,0.3); opacity:${opacity}"></div>`,
                    iconSize: [20, 20]
                });
                const marker = L.marker([comp.lat, comp.lng], { icon: icon });
                let popupHtml = `<div><span class="popup-title">${comp.name}</span><div class="popup-members">` + 
                    relevantMembers.map(m => `<span>ğŸ§‘â€ğŸ’¼ CP${m.cp} ${m.name}${m.status === 'pending' ? ' (ë³´ë¥˜)' : ''}</span><br>`).join('') + 
                    '</div></div>';
                marker.bindPopup(popupHtml);
                markerLayerGroup.addLayer(marker);
                markersRef[comp.name] = marker;
            }
        });
    }

    function renderList() {
        const container = document.getElementById('list-content');
        container.innerHTML = "";
        let displayList = isPendingShown ? [...activeList, ...pendingList] : [...activeList];
        displayList.sort((a,b) => a.cp !== b.cp ? a.cp - b.cp : a.name.localeCompare(b.name));
        
        updateMarkers(displayList);
        
        displayList.forEach(p => {
            const card = document.createElement('div');
            card.className = `person-card ${p.status === 'pending' ? 'pending' : ''}`;
            
            let cardContent = `
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <div>${p.status === 'pending' ? '<span class="badge badge-pending">ë³´ë¥˜</span>' : ''}<strong>${p.name}</strong></div>
                    <span style="font-size: 13px; color: #666;">CP${p.cp}</span>
                </div>
                <div style="font-size:12px; color:${p.company === 'ë¯¸ë“±ë¡' ? '#888' : '#0066FF'}; margin-top:4px;">
                    ${p.company === 'ë¯¸ë“±ë¡' ? 'ğŸ¢ ë¯¸ë“±ë¡' : 'ğŸ¢ ' + p.company}
                </div>`;
            
            if (p.status === 'pending') {
                cardContent += `<button class="btn-status-change" onclick="event.stopPropagation(); promoteToActive('${p.name}')">ì°¸ì„ìœ¼ë¡œ ì „í™˜</button>`;
            }
            
            card.innerHTML = cardContent;
            if (p.isMarkerCompany) card.onclick = () => focusMarker(p.company);
            container.appendChild(card);
        });
    }

    function focusMarker(companyName) {
        if (markersRef[companyName]) {
            map.setView(markersRef[companyName].getLatLng(), 15);
            markersRef[companyName].openPopup();
        }
    }

    function togglePending(show) {
        isPendingShown = show;
        document.getElementById('btn-toggle-pending').innerText = show ? "ì°¸ì„ ëª…ë‹¨ë§Œ ë³´ê¸°" : "ë³´ë¥˜ í¬í•¨ ë³´ê¸°";
        renderList();
    }

    function toggleSidebar(show) {
        document.getElementById('sidebar').style.display = show ? 'flex' : 'none';
        document.getElementById('btn-show-list').style.display = show ? 'none' : 'block';
        setTimeout(() => map.invalidateSize(), 200);
    }

    // ê²€ìƒ‰ ë¡œì§
    const searchInput = document.getElementById('search-input');
    const searchResults = document.getElementById('search-results');
    
    searchInput.addEventListener('input', function() {
        const query = this.value.trim();
        if (!query) { searchResults.style.display = 'none'; return; }
        
        clearTimeout(searchTimeout);
        
        let results = [];
        companies.forEach(c => { if (c.name.includes(query)) results.push({ type: 'company', title: c.name, target: c.name }); });
        [...activeList, ...pendingList].forEach(p => { if (p.name.includes(query)) results.push({ type: 'person', title: `CP${p.cp} ${p.name}`, target: p.company, isMarker: p.isMarkerCompany }); });
        
        renderSearchResults(results);

        if (query.length >= 2) {
            searchTimeout = setTimeout(async () => {
                try {
                    const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=ì„œìš¸ ${query}&limit=5`);
                    const externalPlaces = await response.json();
                    
                    const externalResults = externalPlaces.map(place => ({
                        type: 'place',
                        title: place.display_name.split(',')[0],
                        subtitle: place.display_name,
                        lat: place.lat,
                        lng: place.lon
                    }));
                    
                    if (externalResults.length > 0) {
                        renderSearchResults([...results, ...externalResults]);
                    }
                } catch (err) {
                    console.error("ì¥ì†Œ ê²€ìƒ‰ ì˜¤ë¥˜:", err);
                }
            }, 500);
        }
    });

    function renderSearchResults(results) {
        if (results.length === 0) {
            searchResults.style.display = 'none';
            return;
        }

        searchResults.innerHTML = results.map(res => {
            if (res.type === 'place') {
                return `<div class="search-item" onclick="handlePlaceClick('${res.lat}', '${res.lng}', '${res.title}')">
                            <div class="item-title"><span class="badge badge-place">ì¥ì†Œ</span>${res.title}</div>
                            <div style="font-size:10px; color:#888; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">${res.subtitle}</div>
                        </div>`;
            } else {
                return `<div class="search-item" onclick="handleInternalClick('${res.target}', ${res.isMarker !== false})">
                            <div class="item-title"><span class="badge ${res.type === 'company' ? 'badge-company' : 'badge-person'}">${res.type === 'company' ? 'ê¸°ì—…' : 'ì„ ë°°'}</span>${res.title}</div>
                        </div>`;
            }
        }).join('');
        
        searchResults.style.display = 'block';
    }

    function handleInternalClick(target, isMarker) {
        if (isMarker && markersRef[target]) {
            focusMarker(target);
        }
        closeSearch();
    }

    function handlePlaceClick(lat, lng, title) {
        const position = [parseFloat(lat), parseFloat(lng)];
        map.setView(position, 16);
        
        if (tempSearchMarker) map.removeLayer(tempSearchMarker);
        
        tempSearchMarker = L.marker(position).addTo(map)
            .bindPopup(`<strong>ğŸ“ ${title}</strong>`)
            .openPopup();
            
        closeSearch();
    }

    function closeSearch() {
        searchResults.style.display = 'none';
        searchInput.value = '';
    }

    function init() {
        activeList = initialData.active.map(item => parseItem(item, 'active'));
        pendingList = initialData.pending.map(item => parseItem(item, 'pending'));
        renderList();
    }

    init();
</script>
</body>
</html>
